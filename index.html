<!doctype html>
<html lang="ro">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#e0f2fe" />
    <link rel="manifest" href="./manifest.webmanifest">
    <link rel="apple-touch-icon" href="./icons/icon-192.png">
    <title>MoodLog – Jurnal zilnic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { theme: { extend: { } } };</script>
    <!-- React + ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Recharts -->
    <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
    <!-- Babel for in-browser JSX transform -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      html, body { height: 100%; }
      body { margin:0; }
    </style>
  </head>
  <body class="min-h-screen w-full bg-gradient-to-b from-sky-100 via-cyan-100 to-white">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useMemo } = React;
      const { ResponsiveContainer, LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip } = Recharts;

      const STORAGE_KEY = "moodlog_v1_ro";
      const MOODS = [
        { key: "trist", label: "Trist", icon: "😞", score: 1, color: "bg-red-100 text-red-800 ring-red-300" },
        { key: "ok", label: "Ok", icon: "😐", score: 2, color: "bg-yellow-100 text-yellow-800 ring-yellow-300" },
        { key: "bine", label: "Bine", icon: "🙂", score: 3, color: "bg-green-100 text-green-800 ring-green-300" },
        { key: "foarte_bine", label: "Foarte bine", icon: "😄", score: 4, color: "bg-emerald-100 text-emerald-800 ring-emerald-300" },
      ];

      const moodByKey = Object.fromEntries(MOODS.map(m => [m.key, m]));

      function dateKeyLocal(date = new Date()) {
        const tz = date.getTimezoneOffset() * 60000;
        return new Date(date.getTime() - tz).toISOString().slice(0, 10);
      }

      function formatRo(dateKey) {
        try {
          const [y, m, d] = dateKey.split("-").map(Number);
          return new Date(y, m - 1, d).toLocaleDateString("ro-RO", {
            weekday: "short", day: "2-digit", month: "short",
          });
        } catch {
          return dateKey;
        }
      }

      function lastNDaysKeys(n, fromDateKey = dateKeyLocal()) {
        const [y, m, d] = fromDateKey.split("-").map(Number);
        const start = new Date(y, m - 1, d);
        return Array.from({ length: n }, (_, i) => {
          const dt = new Date(start);
          dt.setDate(dt.getDate() - i);
          return dateKeyLocal(dt);
        });
      }

      function currentMonthDateKeys() {
        const now = new Date();
        const y = now.getFullYear();
        const m = now.getMonth();
        const lastDay = new Date(y, m + 1, 0).getDate();
        return Array.from({ length: lastDay }, (_, i) => dateKeyLocal(new Date(y, m, i + 1)));
      }

      function toScale10(score) {
        if (score == null) return null;
        const map = { 1: 2, 2: 5, 3: 8, 4: 10 };
        return map[score] ?? null;
      }

      function MoodTrackerRO() {
        const todayKey = dateKeyLocal();
        const [entries, setEntries] = useState(() => {
          try {
            const raw = localStorage.getItem(STORAGE_KEY);
            return raw ? JSON.parse(raw) : {};
          } catch { return {}; }
        });

        const todayEntry = entries[todayKey] || null;
        const [selectedMood, setSelectedMood] = useState(todayEntry?.mood || "");
        const [note, setNote] = useState(todayEntry?.note || "");

        // PWA install prompt (Android/Chrome)
        const [deferredPrompt, setDeferredPrompt] = useState(null);
        const [canInstall, setCanInstall] = useState(false);
        useEffect(() => {
          const handler = (e) => {
            e.preventDefault();
            setDeferredPrompt(e);
            setCanInstall(true);
          };
          window.addEventListener("beforeinstallprompt", handler);
          return () => window.removeEventListener("beforeinstallprompt", handler);
        }, []);

        const doInstall = async () => {
          if (!deferredPrompt) return;
          deferredPrompt.prompt();
          await deferredPrompt.userChoice;
          setDeferredPrompt(null);
          setCanInstall(false);
        };

        useEffect(() => {
          try { localStorage.setItem(STORAGE_KEY, JSON.stringify(entries)); } catch {}
        }, [entries]);

        useEffect(() => {
          if (todayEntry) {
            setSelectedMood(todayEntry.mood || "");
            setNote(todayEntry.note || "");
          }
        }, [todayKey]);

        function saveToday() {
          if (!selectedMood) return;
          setEntries(prev => ({
            ...prev,
            [todayKey]: { mood: selectedMood, note: note?.trim() || "", timestamp: Date.now() },
          }));
        }

        function clearAll() {
          if (!confirm("Sigur vrei să ștergi toate datele?")) return;
          setEntries({});
          try { localStorage.removeItem(STORAGE_KEY); } catch {}
        }

        function exportJson() {
          const blob = new Blob([JSON.stringify({ version: 2, entries }, null, 2)], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url; a.download = `moodlog_${dateKeyLocal()}.json`;
          document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        }

        function importJson(file) {
          if (!file) return;
          const reader = new FileReader();
          reader.onload = () => {
            try {
              const obj = JSON.parse(reader.result);
              if (obj && obj.entries && typeof obj.entries === "object") setEntries(obj.entries);
              else alert("Fișier invalid.");
            } catch { alert("Nu am putut citi fișierul."); }
          };
          reader.readAsText(file);
        }

        const stats = useMemo(() => {
          const keys = Object.keys(entries);
          if (keys.length === 0) return { daysLogged: 0, last7Avg: null, streak: 0 };
          const scores = (k) => (moodByKey[entries[k]?.mood]?.score ?? null);
          const last7 = lastNDaysKeys(7);
          const vals = last7.map(k => scores(k)).filter(v => v != null);
          const last7Avg = vals.length ? (vals.reduce((a, b) => a + b, 0) / vals.length) : null;
          let streak = 0;
          const maxCheck = 365;
          for (let i = 0; i < maxCheck; i++) {
            const k = lastNDaysKeys(i + 1)[i];
            if (entries[k]) streak += 1; else break;
          }
          return { daysLogged: keys.length, last7Avg, streak };
        }, [entries]);

        const chartData = useMemo(() => {
          const keys = currentMonthDateKeys();
          return keys.map((k) => {
            const e = entries[k];
            const s = e ? moodByKey[e.mood]?.score : null;
            return { day: String(new Date(k).getDate()), value: toScale10(s), label: e ? moodByKey[e.mood]?.label : null };
          });
        }, [entries]);

        // Register service worker
        useEffect(() => {
          if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("./service-worker.js").catch(() => {});
          }
        }, []);

        return (
          <div className="p-6">
            <div className="max-w-3xl mx-auto">
              <header className="mb-6 flex items-start justify-between gap-4">
                <div>
                  <h1 className="text-3xl font-semibold tracking-tight">Jurnal zilnic – starea mea</h1>
                  <p className="text-slate-600">Notează rapid cum te simți în fiecare zi. Datele rămân local pe dispozitiv.</p>
                </div>
                {canInstall && (
                  <button onClick={doInstall} className="rounded-xl bg-slate-900 text-white px-4 py-2">
                    Instalează
                  </button>
                )}
              </header>

              <section className="mb-6">
                <div className="rounded-2xl border border-slate-200 bg-white/90 backdrop-blur shadow-sm p-5">
                  <div className="flex items-baseline justify-between gap-2">
                    <h2 className="text-xl font-medium">Astăzi • <span className="font-semibold">{formatRo(dateKeyLocal())}</span></h2>
                    <div className="text-sm text-slate-500">{entries[dateKeyLocal()] ? "Salvat" : "Nesalvat"}</div>
                  </div>

                  <div className="mt-4 grid grid-cols-2 sm:grid-cols-4 gap-3">
                    {MOODS.map(m => (
                      <button key={m.key} onClick={() => setSelectedMood(m.key)}
                        className={\`group flex items-center justify-center gap-2 rounded-2xl border p-3 transition ring-2 ring-offset-2 \${selectedMood === m.key ? \`\${m.color} border-transparent\` : "bg-white border-slate-200 hover:bg-slate-50 ring-transparent"}\`}>
                        <span className="text-2xl" aria-hidden>{m.icon}</span>
                        <span className="font-medium">{m.label}</span>
                      </button>
                    ))}
                  </div>

                  <label className="block mt-4 text-sm font-medium text-slate-700">Notiță (opțional)</label>
                  <textarea value={note} onChange={(e) => setNote(e.target.value)}
                            placeholder="Adaugă câteva cuvinte despre ziua ta..."
                            className="mt-2 w-full rounded-xl border border-slate-200 p-3 focus:outline-none focus:ring-2 focus:ring-slate-300" rows={3} />

                  <div className="mt-4 flex flex-wrap items-center gap-3">
                    <button onClick={saveToday} disabled={!selectedMood}
                            className="rounded-xl bg-slate-900 text-white px-4 py-2 disabled:opacity-50">
                      {entries[dateKeyLocal()] ? "Actualizează ziua" : "Salvează ziua"}
                    </button>
                    <button onClick={exportJson} className="rounded-xl border border-slate-300 px-4 py-2"
                            title="Descarcă un fișier .json cu toate datele">Exportă</button>
                    <label className="rounded-xl border border-slate-300 px-4 py-2 cursor-pointer">Importă
                      <input type="file" accept="application/json" className="hidden"
                             onChange={(e) => importJson(e.target.files?.[0])} />
                    </label>
                    <button onClick={clearAll} className="ml-auto rounded-xl border border-red-300 text-red-700 px-4 py-2">Resetare</button>
                  </div>
                </div>
              </section>

              <section className="mb-6">
                <div className="rounded-2xl border border-slate-200 bg-white/90 backdrop-blur shadow-sm p-5">
                  <h3 className="text-lg font-medium mb-3">Grafic – luna curentă</h3>
                  <div className="h-64 w-full">
                    <ResponsiveContainer width="100%" height="100%">
                      <LineChart data={chartData} margin={{ top: 10, right: 16, left: 0, bottom: 0 }}>
                        <CartesianGrid strokeDasharray="3 3" />
                        <XAxis dataKey="day" tickMargin={8} interval={0} />
                        <YAxis domain={[1, 10]} tickCount={10} allowDecimals={false} />
                        <Tooltip formatter={(value, _n, p) => [value, p?.payload?.label || "Fără notiță"]} labelFormatter={(l) => \`Ziua \${l}\`} />
                        <Line type="monotone" dataKey="value" strokeWidth={3} dot={{ r: 3 }} isAnimationActive={false} />
                      </LineChart>
                    </ResponsiveContainer>
                  </div>
                  <p className="text-xs text-slate-500 mt-2">Scala 1–10: Trist≈2, Ok≈5, Bine≈8, Foarte bine≈10. Punctele lipsă indică zile fără înregistrare.</p>
                </div>
              </section>

              <section className="mb-6 grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div className="rounded-2xl border border-slate-200 bg-white/90 backdrop-blur shadow-sm p-4">
                  <div className="text-slate-500 text-sm">Zile înregistrate</div>
                  <div className="text-3xl font-semibold">{stats.daysLogged}</div>
                </div>
                <div className="rounded-2xl border border-slate-200 bg-white/90 backdrop-blur shadow-sm p-4">
                  <div className="text-slate-500 text-sm">Medie ultimele 7 zile</div>
                  <div className="text-3xl font-semibold">{stats.last7Avg ? stats.last7Avg.toFixed(2) : "—"}</div>
                  <div className="text-slate-500 text-xs mt-1">(1=trist, 4=foarte bine)</div>
                </div>
                <div className="rounded-2xl border border-slate-200 bg-white/90 backdrop-blur shadow-sm p-4">
                  <div className="text-slate-500 text-sm">Streak (zile la rând)</div>
                  <div className="text-3xl font-semibold">{stats.streak}</div>
                </div>
              </section>

              <section className="mb-8">
                <div className="rounded-2xl border border-slate-200 bg-white/90 backdrop-blur shadow-sm p-5">
                  <h4 className="text-base font-semibold mb-2">Sfat</h4>
                  <ul className="list-disc pl-5 text-slate-600 space-y-1 text-sm">
                    <li>Încearcă să înregistrezi la aceeași oră în fiecare zi (de exemplu seara).</li>
                    <li>După 2–3 săptămâni, uită-te la medie și note – observă ce îți influențează starea.</li>
                    <li>Datele sunt doar pe acest dispozitiv. Folosește <em>Exportă</em> periodic pentru backup.</li>
                  </ul>
                </div>
              </section>
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<MoodTrackerRO />);
    </script>

    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker.register("./service-worker.js").catch(() => {});
        });
      }
    </script>
  </body>
</html>